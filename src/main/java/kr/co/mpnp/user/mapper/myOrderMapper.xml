<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.mpnp.myOrderMapper">
<!-- domain mapping -->
<resultMap type="MyOrderDomain" id="myOrderDom">
	<result column="inputdate" property="inputDateS"/>
	<result column="status" property="prdName"/>
	<result column="totalcnt" property="totalCnt"/>
	<result column="name_1" property="memberName"/>
	<result column="zipcode" property="zipcode"/>
	<result column="addr" property="addr"/>
	<result column="addr_detail" property="addrDetail"/>
	<result column="phone" property="phone"/>
	<result column="shipreq" property="shipReq"/>
	<result column="actual_price" property="actualPrice"/>
	<result column="productid" property="prdId"/>
	<result column="name" property="prdName"/>
	<result column="product_img" property="prdImg"/>
</resultMap>

<!-- 기간별 주문내역 조회 -->
<select id="selectOrderAList" parameterType="MyOrderVO" resultMap="myOrderDom">
 <![CDATA[
SELECT to_char(o.INPUTDATE,'yyyy-mm-dd'), o.STATUS, o.ACTUAL_PRICE, r.TOTALCNT, p.NAME,i.PRODUCT_IMG
FROM ORDERS o, PRODUCT p, ORDER_DETAIL r,PRODUCT_IMG i
WHERE (r.ORDERID = o.ORDERID and r.PRODUCTID = p.PRODUCTID and i.PRODUCTID = p.PRODUCTID) and o.ORDERID='or_0000004'
  and #{findStartDate}< to_char(o.inputdate,'yyyy-mm-dd') and to_char(o.inputdate,'yyyy-mm-dd') < #{findEndDate}
]]>
</select>

<!-- 주문 상세내역 조회 -->
<select id="selectOrderDetail" parameterType="String" resultType="MyOrderDomain">
SELECT o.STATUS status, o.INPUTDATE inputDate, p.NAME prdName, p.PRICE prdPrice, r.TOTALCNT totalCnt, d.NAME deliveryName, d.ZIPCODE zipcode, d.ADDR addr, d.ADDR_DETAIL addrDetail, d.RECEIVER receiver, d.PHONE phone, o.SHIPREQ shipReq, o.ACTUAL_PRICE  actualPrice
FROM ORDERS o, ORDER_DETAIL r, PRODUCT p, DESTINATION d,MEMBER m
WHERE (r.ORDERID = o.ORDERID and r.PRODUCTID = p.PRODUCTID and o.ID = m.ID and d.ID = m.ID) and r.ORDER_DETAILID=#{orderDetailId}
</select>

<!-- 기간 내 주문상태 조회(아이디,시작,끝)-->
<select id="selectOrderStatusCnt" parameterType="MyOrderVO" resultType="String">
 <![CDATA[
SELECT o.status
FROM ORDERS o,MEMBER m
WHERE (o.id = m.id ) and  m.id=#{id}
and #{findStartDate} < to_char(o.INPUTDATE,'yyyy-mm-dd') and to_char(o.INPUTDATE,'yyyy-mm-dd') <#{findEndDate}
]]>
</select>

<!-- 주문취소누르면 수행되는 쿼리들 -->
<!-- 1. 가격 감산을 위한 쿼리 -->

<!-- 1) 주문상세코드의 가격 조회: 파라미터로 받아서 필요없는데 일단 적어둔다 -->
<select id="selectPriceIndivisual" parameterType="String" resultType="int">
select r.TOTALCNT * p.PRICE cntPrice
from ORDER_DETAIL r, PRODUCT p
where (r.PRODUCTID = p.PRODUCTID) and ORDER_DETAILID=#{orderDetailId}
</select>

<!-- 2) 해당 주문코드의 주문전체 가격조회 : 이건 필요-->
<select id="selectPriceTotal" parameterType="String" resultType="int">
select sum(o.ACTUAL_PRICE) totalPrice
from ORDERS o,ORDER_DETAIL r
where (r.ORDERID =o.ORDERID) and o.ORDERID=#{orderId}
</select>

<!-- 주문취소 쿼리들 -->
<!-- 1) 주문 개별 취소 (cascade적용한 상태- 주문상세 ~리뷰까지 삭제됨)-->
<delete id="deleteCancelIndivisual" parameterType="String">
delete from ORDER_DETAIL where ORDER_DETAILID=#{orderDetailId}
</delete>
<!-- 2)주문 전체 취소((cascade적용한 상태- 주문테이블 ~ 리뷰까지 삭제됨) -->
<delete id="deleteCancelTotal" parameterType="String">
delete from ORDERS where ORDERID=#{orderId}
</delete>

<!-- 페이징 :전체 게시물 수 조회 -->
<select id="selectTotalPageCount"  resultType="int">
select count(*) cnt
from ORDER_DETAIL
</select>


</mapper>